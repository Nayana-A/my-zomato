# azure-pipelines.yml
trigger:
- main

pool:
  name: magedpool

variables:
  imageName: 'foodcart-node'

steps:
# 1️⃣ Install dependencies and test
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Use Node.js 20'

- script: |
    npm install
    npm test || echo "no tests"
  displayName: 'Install & Test'

- script: |
    sudo apt-get update -y
    sudo apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt-get update -y
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io
    sudo usermod -aG docker $(whoami)
  displayName: 'Install Docker on Managed Agent'


# 2️⃣ Build and push Docker image
- task: Docker@2
  displayName: 'Build and Push image to ACR'
  inputs:
    containerRegistry: 'ACR-myzomato'     # Create this service connection
    repository: '$(imageName)'
    command: 'buildAndPush'
    Dockerfile: 'my-zomato/Dockerfile'
    tags: |
      $(Build.BuildId)
